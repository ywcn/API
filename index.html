<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROI ä»ªè¡¨ç›˜ï¼ˆSupabase ç‰ˆï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family:"Microsoft YaHei"; background:#1e1e2f; color:#eee; margin:0; padding:18px; transition: background 0.3s, color 0.3s;}
h1 { text-align:center; margin-bottom:14px; font-size:20px;}
.container { display:flex; flex-wrap:wrap; gap:18px; justify-content:space-between;}
.box { background:#2a2a3f; border-radius:12px; padding:14px; flex:1 1 320px; box-shadow:0 6px 18px rgba(0,0,0,0.45);}
input, button, select { border-radius:6px; padding:8px; margin:6px 0; border: none; box-sizing:border-box; }
input[type="number"]{-moz-appearance:textfield;}
.summary { display:flex; gap:12px; justify-content:space-around; flex-wrap:wrap; margin-top:8px;}
.kpi { font-weight:700; }
#dataTable { width:100%; border-collapse:collapse; margin-top:8px; color:#eee; }
#dataTable th, #dataTable td { padding:8px; border-bottom:1px solid #444; text-align:center;}
.tab { margin-bottom:12px; }
.tab button { padding:8px 14px; margin-right:8px; border-radius:6px; border:none; background:#333; color:#fff; cursor:pointer;}
.tab button.active { background:#007aff; }
.theme-btn { position:fixed; right:14px; top:14px; padding:8px 10px; background:#007aff;color:#fff;border-radius:8px;border:none; z-index:200;}
@media(max-width:768px){ .container{flex-direction:column;} }
</style>
</head>
<body>
<h1>ğŸ” ROI ä»ªè¡¨ç›˜ï¼ˆSupabaseï¼‰</h1>
<button class="theme-btn" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>

<div id="auth" class="box" style="max-width:420px;margin:0 auto 18px;">
  <h3>ç™»å½•ï¼ˆæœ¬åœ°ä¿å­˜ï¼Œä¾›æ¼”ç¤ºä½¿ç”¨ï¼‰</h3>
  <input id="email" type="text" placeholder="ç”¨æˆ·åï¼ˆä»»æ„ï¼‰" />
  <input id="password" type="password" placeholder="å¯†ç ï¼ˆä»»æ„ï¼‰" />
  <div>
    <button onclick="login()" style="background:#007aff;color:#fff;">ç™»å½•å¹¶è®°ä½</button>
    <button onclick="clearSaved()" style="background:#ff3b30;color:#fff;">æ¸…é™¤ä¿å­˜</button>
  </div>
  <p style="font-size:12px;color:#bbb;margin-top:8px;">ï¼ˆä¸ºç®€åŒ–æ¼”ç¤ºï¼Œç™»å½•ä¸ä½¿ç”¨åç«¯éªŒè¯ï¼Œä»…æœ¬åœ°ä¿å­˜å¹¶è¿›å…¥ä»ªè¡¨ç›˜ï¼‰</p>
</div>

<div id="main" style="display:none;">
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event,'History')">å†å²è®°å½•</button>
    <button class="tablinks" onclick="openTab(event,'Simulate')">æŠ•èµ„æ¨¡æ‹Ÿ</button>
  </div>

  <div id="History" class="tabcontent" style="display:block;">
    <div class="container">
      <div class="box">
        <h3>æ·»åŠ æŠ•èµ„è®°å½•</h3>
        <input id="project_name" type="text" placeholder="é¡¹ç›®åç§°" />
        <input id="cost" type="number" placeholder="æˆæœ¬ (Â¥)" />
        <input id="revenue" type="number" placeholder="æ”¶ç›Š (Â¥)" />
        <div>
          <button onclick="addRecord()" style="background:#00a86b;color:#fff;">æ·»åŠ </button>
          <button onclick="exportExcel()" style="background:#ff9500;color:#fff;">å¯¼å‡º Excel</button>
          <button onclick="sortByROI()" style="background:#ff6b6b;color:#fff;">æŒ‰ ROI æ’åº</button>
        </div>

        <div class="summary" id="summary">
          <div>æ€»æŠ•èµ„: <span id="totalCost" class="kpi">0</span></div>
          <div>æ€»æ”¶ç›Š: <span id="totalRevenue" class="kpi">0</span></div>
          <div>å¹³å‡ROI: <span id="avgROI" class="kpi">0%</span></div>
          <div>æ€»ä½“ROI: <span id="overallROI" class="kpi">0%</span></div>
        </div>
        <div id="advice" style="text-align:center;margin-top:8px;color:#ffb86b;"></div>

        <table id="dataTable">
          <thead><tr><th>#</th><th>é¡¹ç›®</th><th>æˆæœ¬</th><th>æ”¶ç›Š</th><th>ROI%</th><th>æ“ä½œ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="box">
        <h3>å¯è§†åŒ–</h3>
        <canvas id="barChart" style="max-height:260px;"></canvas>
        <canvas id="roiChart" style="max-height:220px;"></canvas>
        <canvas id="donutChart" style="max-width:260px;margin-top:10px;"></canvas>
      </div>
    </div>
  </div>

  <div id="Simulate" class="tabcontent" style="display:none;">
    <div class="box" style="max-width:720px;margin:0 auto;">
      <h3>æŠ•èµ„æ¨¡æ‹Ÿé¢„æµ‹ï¼ˆå•æ¡ï¼‰</h3>
      <div class="simulate-box">
        <input id="simCost" type="number" placeholder="æ¨¡æ‹ŸæŠ•èµ„é‡‘é¢ (Â¥)" />
        <button onclick="simulateROI()" style="background:#34c759;color:#fff;">æ¨¡æ‹Ÿ ROI</button>
      </div>
      <div id="simResult" style="margin-top:10px;color:#9cf;"></div>
      <canvas id="simBarChart" style="margin-top:10px;"></canvas>
      <canvas id="simRoiChart" style="margin-top:10px;"></canvas>
    </div>
  </div>
</div>

<script>
const API_BASE = "/api/records"; // relative; when deployed on Vercel works as https://<your>.vercel.app/api/records

function toggleTheme(){
  const body = document.body;
  if(body.style.background === 'white'){
    body.style.background='#1e1e2f'; body.style.color='#eee';
    document.querySelectorAll('.box').forEach(b=>b.style.background='#2a2a3f');
  } else {
    body.style.background='white'; body.style.color='#111';
    document.querySelectorAll('.box').forEach(b=>b.style.background='#fff');
  }
}

function openTab(evt, name){
  document.querySelectorAll('.tabcontent').forEach(tc=>tc.style.display='none');
  document.getElementById(name).style.display='block';
  document.querySelectorAll('.tablinks').forEach(btn=>btn.classList.remove('active'));
  if(evt) evt.currentTarget.classList.add('active');
}

// ---------------- Login (local) ----------------
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  if(!email||!password){ alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '); return; }
  localStorage.setItem('roi_user', JSON.stringify({email,password}));
  document.getElementById('auth').style.display='none';
  document.getElementById('main').style.display='block';
  fetchRecords();
}
function clearSaved(){ localStorage.removeItem('roi_user'); alert('å·²æ¸…é™¤ä¿å­˜'); }
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('roi_user');
  if(saved){ const u=JSON.parse(saved); document.getElementById('email').value=u.email; document.getElementById('password').value=u.password; login(); }
});

// ---------------- CRUD ----------------
let records = [];
async function fetchRecords(){
  try{
    const res = await fetch(API_BASE);
    if(!res.ok) throw new Error('ç½‘ç»œæˆ–æ¥å£é”™è¯¯: '+res.status);
    const data = await res.json();
    records = data.map(r=>({...r, roi: (parseFloat(r.revenue)-parseFloat(r.cost))/parseFloat(r.cost)*100}));
    renderTable();
  }catch(e){ console.error(e); alert('è·å–è®°å½•å¤±è´¥ï¼š'+e.message); }
}

async function addRecord(){
  const name=document.getElementById('project_name').value.trim();
  const cost=parseFloat(document.getElementById('cost').value);
  const revenue=parseFloat(document.getElementById('revenue').value);
  if(!name || isNaN(cost) || isNaN(revenue)){ alert('è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯'); return; }
  try{
    const res = await fetch(API_BASE, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({project_name:name,cost,revenue})});
    if(!res.ok) throw new Error('æ·»åŠ å¤±è´¥: '+res.status);
    const data = await res.json();
    records.push({...data, roi:(data.revenue-data.cost)/data.cost*100});
    renderTable();
    document.getElementById('project_name').value=''; document.getElementById('cost').value=''; document.getElementById('revenue').value='';
  }catch(e){ console.error(e); alert('æ·»åŠ å¤±è´¥ï¼š'+e.message); }
}

async function deleteRecord(id){
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return;
  try{
    const res = await fetch(API_BASE + '?id=' + id, {method:'DELETE'});
    if(!res.ok) throw new Error('åˆ é™¤å¤±è´¥: '+res.status);
    records = records.filter(r=>r.id !== id);
    renderTable();
  }catch(e){ console.error(e); alert('åˆ é™¤å¤±è´¥ï¼š'+e.message); }
}

// ---------------- Render / Charts / Summary ----------------
function renderTable(){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  let totalCost=0, totalRevenue=0;
  records.forEach((r,i)=>{
    totalCost += parseFloat(r.cost); totalRevenue += parseFloat(r.revenue);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.project_name}</td><td>${r.cost}</td><td>${r.revenue}</td><td>${r.roi.toFixed(2)}</td><td><button onclick="deleteRecord(${r.id})" style="background:#ff3b30;color:#fff;border:none;padding:6px 8px;border-radius:6px;">åˆ é™¤</button></td>`;
    tbody.appendChild(tr);
  });
  const avgROI = records.length ? records.reduce((s,r)=>s+r.roi,0)/records.length : 0;
  const overallROI = totalCost ? ((totalRevenue - totalCost)/totalCost*100) : 0;
  document.getElementById('totalCost').innerText = totalCost.toFixed(2);
  document.getElementById('totalRevenue').innerText = totalRevenue.toFixed(2);
  document.getElementById('avgROI').innerText = avgROI.toFixed(2) + '%';
  document.getElementById('overallROI').innerText = overallROI.toFixed(2) + '%';
  document.getElementById('advice').innerText = overallROI >= 20 ? 'è¡¨ç°è‰¯å¥½' : 'è°¨æ…æ“ä½œ';

  drawCharts();
}

let barChart, roiChart, donutChart, simBarChart, simRoiChart;

function drawCharts(){
  const labels = records.map(r=>r.project_name);
  const costs = records.map(r=>r.cost);
  const revenues = records.map(r=>r.revenue);
  const rois = records.map(r=>r.roi);

  if(!barChart){
    const ctx = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{label:'æˆæœ¬', data:costs},{label:'æ”¶ç›Š', data:revenues}] }, options:{responsive:true} });
  } else {
    barChart.data.labels = labels; barChart.data.datasets[0].data = costs; barChart.data.datasets[1].data = revenues; barChart.update();
  }

  if(!roiChart){
    const ctx = document.getElementById('roiChart').getContext('2d');
    roiChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'ROI%', data:rois, borderColor:'#00ffff', fill:false}] }, options:{responsive:true} });
  } else { roiChart.data.labels = labels; roiChart.data.datasets[0].data = rois; roiChart.update(); }

  const totalCost = records.reduce((s,r)=>s+parseFloat(r.cost),0);
  const totalRevenue = records.reduce((s,r)=>s+parseFloat(r.revenue),0);
  const overallROI = totalCost ? ((totalRevenue-totalCost)/totalCost*100) : 0;

  if(!donutChart){
    const ctx = document.getElementById('donutChart').getContext('2d');
    donutChart = new Chart(ctx, { type:'doughnut', data:{ labels:['ROI','å‰©ä½™'], datasets:[{data:[overallROI, 100-overallROI}]} }, options:{responsive:true} });
  } else { donutChart.data.datasets[0].data = [overallROI, 100-overallROI]; donutChart.update();}
}

// ---------------- Simulate ----------------
function simulateROI(){
  const simCost = parseFloat(document.getElementById('simCost').value);
  if(isNaN(simCost)){ alert('è¯·è¾“å…¥æ¨¡æ‹Ÿé‡‘é¢'); return; }
  const avgROI = records.length ? records.reduce((s,r)=>s+r.roi,0)/records.length : 10;
  const simRevenue = simCost * (1 + avgROI/100);
  const simROI = ( (simRevenue - simCost) / simCost * 100 ).toFixed(2);
  document.getElementById('simResult').innerText = `é¢„æµ‹æ”¶ç›Š Â¥${simRevenue.toFixed(2)}ï¼Œé¢„æµ‹ ROI ${simROI}%`;

  const labels = records.map(r=>r.project_name).concat('æ¨¡æ‹Ÿ');
  const costs = records.map(r=>r.cost).concat(simCost);
  const revenues = records.map(r=>r.revenue).concat(simRevenue);
  const rois = records.map(r=>r.roi).concat(parseFloat(simROI));

  if(!simBarChart){
    const ctx = document.getElementById('simBarChart').getContext('2d');
    simBarChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{label:'æˆæœ¬',data:costs},{label:'æ”¶ç›Š',data:revenues}] } });
  } else { simBarChart.data.labels = labels; simBarChart.data.datasets[0].data = costs; simBarChart.data.datasets[1].data = revenues; simBarChart.update(); }

  if(!simRoiChart){
    const ctx = document.getElementById('simRoiChart').getContext('2d');
    simRoiChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'ROI%', data:rois, borderColor:'#00ffff', fill:false}] } });
  } else { simRoiChart.data.labels = labels; simRoiChart.data.datasets[0].data = rois; simRoiChart.update();}
}

// ---------------- Excel export ----------------
function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(records.map((r,i)=>({åºå·:i+1, é¡¹ç›®:r.project_name, æˆæœ¬:r.cost, æ”¶ç›Š:r.revenue, ROI:r.roi.toFixed(2)})));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ROIè®°å½•');
  XLSX.writeFile(wb, 'roi_records.xlsx');
}

// ---------------- Utility ----------------
function sortByROI(){ records.sort((a,b)=>b.roi-a.roi); renderTable(); }
</script>
</body>
</html>
